# Tilt Events API Documentation

## Overview

The Tilt Events API stores and retrieves tilt detection events from the TiltCheck Discord bot. Events are generated by `@tiltcheck/tiltcheck-core` when the bot detects tilt patterns in user messages, and are persisted to the backend for historical analysis.

**Base URL:** `/api/tilt`  
**Port:** 3000 (Backend)

---

## Endpoints

### POST /api/tilt/events

Store a tilt detection event from the Discord bot.

**Request Body:**
```json
{
  "userId": "discord_user_id",
  "timestamp": 1702000000000,
  "signals": [
    {
      "type": "rapid-messages",
      "severity": 3,
      "confidence": 0.7
    },
    {
      "type": "rage-keywords",
      "severity": 4,
      "confidence": 0.85
    }
  ],
  "tiltScore": 3.5,
  "context": "discord-dm"
}
```

**Response (Success - 200):**
```json
{
  "success": true,
  "message": "Tilt event recorded",
  "eventId": "12345"
}
```

**Response (Error - 400):**
```json
{
  "error": "Missing required fields: userId, timestamp, signals, tiltScore"
}
```

**Response (Error - 503):**
```json
{
  "error": "Database not connected"
}
```

**Parameters:**
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| userId | string | Yes | Discord user ID |
| timestamp | number | Yes | Unix timestamp (milliseconds) |
| signals | array | Yes | Array of detected tilt signals |
| tiltScore | number | Yes | Calculated tilt score (0-5) |
| context | string | No | Context of detection: `discord-dm` or `discord-guild` (default: `discord-dm`) |

---

### GET /api/tilt/history/:userId

Retrieve tilt event history for a user (last 7 days by default).

**Request:**
```bash
GET /api/tilt/history/123456789?days=7&limit=50
```

**Response (200):**
```json
{
  "success": true,
  "userId": "123456789",
  "count": 42,
  "days": 7,
  "events": [
    {
      "id": "12345",
      "user_id": "123456789",
      "timestamp": "2024-12-08T15:30:00.000Z",
      "signals": [
        {
          "type": "rapid-messages",
          "severity": 3,
          "confidence": 0.7
        }
      ],
      "tilt_score": 3.2,
      "context": "discord-dm",
      "created_at": "2024-12-08T15:30:05.000Z"
    }
    // ... more events
  ]
}
```

**Query Parameters:**
| Parameter | Type | Default | Max | Description |
|-----------|------|---------|-----|-------------|
| days | number | 7 | 30 | Number of days to look back |
| limit | number | 100 | 500 | Maximum results to return |

---

### GET /api/tilt/stats/:userId

Get tilt statistics for a user across all time.

**Request:**
```bash
GET /api/tilt/stats/123456789
```

**Response (200):**
```json
{
  "success": true,
  "userId": "123456789",
  "totalEvents": 247,
  "averageTiltScore": 2.85,
  "maxTiltScore": 5,
  "lastEventAt": "2024-12-08T15:30:00.000Z",
  "eventsLast24h": 3,
  "eventsLast7d": 18
}
```

**Returns:**
| Field | Type | Description |
|-------|------|-------------|
| totalEvents | number | Total tilt events recorded |
| averageTiltScore | number | Average tilt score across all events |
| maxTiltScore | number | Highest tilt score recorded |
| lastEventAt | ISO string | Timestamp of most recent tilt event |
| eventsLast24h | number | Number of events in last 24 hours |
| eventsLast7d | number | Number of events in last 7 days |

---

### DELETE /api/tilt/events/:eventId

Delete a specific tilt event (for testing/cleanup).

**Request:**
```bash
DELETE /api/tilt/events/12345
```

**Response (200):**
```json
{
  "success": true,
  "message": "Event deleted"
}
```

---

## Signal Types

Tilt signals detected by the bot:

| Signal Type | Description | Severity Range |
|-------------|-------------|-----------------|
| `rapid-messages` | 5+ messages in 30 seconds | 1-5 |
| `caps-spam` | Multiple lines of ALL CAPS | 1-5 |
| `rage-keywords` | Profanity or rage language | 2-5 |
| `loan-requests` | Language indicating desperation | 2-5 |
| `loss-streak` | Multiple losses detected | 2-5 |
| `bet-sizing` | Sudden increase in bet amounts | 2-5 |

---

## Data Flow

```
Discord Message
    ↓
@tiltcheck/tiltcheck-core (analyzeMessages)
    ↓
tilt.detected event (EventRouter)
    ↓
Discord Bot (tilt-events-handler.ts)
    ↓
POST /api/tilt/events
    ↓
Backend API (routes/tilt.ts)
    ↓
Supabase (tilt_events table)
```

---

## Integration with Discord Bot

The bot automatically sends tilt events via `initializeTiltEventsHandler()`:

```typescript
// In apps/discord-bot/src/index.ts
import { initializeTiltEventsHandler } from './handlers/tilt-events-handler.js';

// During bot startup:
initializeTiltEventsHandler();
```

The handler subscribes to `tilt.detected` events and POSTs them to the backend:

```typescript
// In apps/discord-bot/src/handlers/tilt-events-handler.ts
eventRouter.subscribe('tilt.detected', async (event) => {
  const response = await fetch(`${BACKEND_URL}/api/tilt/events`, {
    method: 'POST',
    body: JSON.stringify({
      userId: tiltData.userId,
      timestamp: tiltData.timestamp,
      signals: tiltData.signals,
      tiltScore: tiltData.tiltScore,
      context: 'discord-dm',
    })
  });
});
```

---

## Usage in Commands

Fetch user's tilt history in Discord commands:

```typescript
import { getUserTiltHistory, getUserTiltStats } from '../handlers/tilt-events-handler.js';

// In a command:
const history = await getUserTiltHistory(userId, { days: 7, limit: 10 });
const stats = await getUserTiltStats(userId);

// Display in embed:
const embed = successEmbed(
  'Your Tilt Stats',
  `Total events: ${stats.totalEvents}\n` +
  `Avg score: ${stats.averageTiltScore}\n` +
  `Last 24h: ${stats.eventsLast24h}`
);
```

---

## Environment Variables

Set in `.env.local`:

```env
# Backend URL for tilt events API (Discord bot)
BACKEND_URL=http://localhost:3000

# Or for production:
BACKEND_URL=https://api.tiltcheck.me
```

---

## Database Schema

```sql
CREATE TABLE tilt_events (
  id BIGSERIAL PRIMARY KEY,
  user_id TEXT NOT NULL,
  timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
  signals JSONB NOT NULL,
  tilt_score DECIMAL(3, 2) NOT NULL,
  context TEXT DEFAULT 'discord-dm',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL
);

CREATE INDEX idx_tilt_events_user_timestamp ON tilt_events(user_id, timestamp DESC);
```

See `docs/migrations/001-tilt-events.sql` for complete schema.

---

## Error Handling

All endpoints return appropriate HTTP status codes:

| Status | Meaning | Example |
|--------|---------|---------|
| 200 | Success | Event stored successfully |
| 400 | Bad request | Missing required fields |
| 404 | Not found | User has no events |
| 500 | Server error | Database error |
| 503 | Service unavailable | Database not connected |

---

## Rate Limiting

No rate limiting currently implemented. For production, consider adding:

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 minute
  max: 100, // 100 requests per minute
});

app.use('/api/tilt', limiter);
```

---

## Example: Complete Flow

1. **User types tilted message in Discord:**
   ```
   "fuck this rigged game!!!"
   ```

2. **Bot detects tilt:**
   - Analyzes message for keywords, rapid typing, etc.
   - Calculates tilt score (e.g., 3.8)
   - Emits `tilt.detected` event

3. **Handler posts to backend:**
   ```
   POST /api/tilt/events
   {
     "userId": "12345",
     "timestamp": 1702000000000,
     "signals": [{"type": "rage-keywords", "severity": 4, "confidence": 0.9}],
     "tiltScore": 3.8,
     "context": "discord-dm"
   }
   ```

4. **Backend stores in Supabase:**
   - Creates row in `tilt_events` table
   - Returns success response

5. **User queries their history:**
   ```
   /tilt history
   → Bot fetches GET /api/tilt/history/12345?days=7
   → Displays last 7 days of tilt events
   ```

---

## Testing

Test endpoints with curl:

```bash
# Record a tilt event
curl -X POST http://localhost:3000/api/tilt/events \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test-user-123",
    "timestamp": '$(date +%s000)',
    "signals": [{"type": "rage-keywords", "severity": 4}],
    "tiltScore": 3.5,
    "context": "discord-dm"
  }'

# Get history
curl http://localhost:3000/api/tilt/history/test-user-123?days=7

# Get stats
curl http://localhost:3000/api/tilt/stats/test-user-123

# Delete an event
curl -X DELETE http://localhost:3000/api/tilt/events/12345
```

---

## Future Enhancements

- [ ] Tilt prediction (ML model)
- [ ] Cooldown recommendations
- [ ] Dashboard visualization
- [ ] Notification webhooks
- [ ] Export as CSV/JSON
- [ ] Filtering by signal type
- [ ] Comparison across users (anonymized)
