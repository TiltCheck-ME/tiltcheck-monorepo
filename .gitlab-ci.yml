image: node:20

stages:
  - build-test

variables:
  PNPM_HOME: ".pnpm-store"

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
    - node_modules

before_script:
  - corepack enable
  - corepack prepare pnpm@10.29.1 --activate
  - pnpm config set store-dir .pnpm-store
  - pnpm install --frozen-lockfile

build-test:
  stage: build-test
  script:
    # Mirroring the core build steps from GitHub Actions for reliability
    - |
      pnpm --filter @tiltcheck/types run build
      pnpm --filter @tiltcheck/config run build
      pnpm --filter @tiltcheck/esm-utils run build
      pnpm --filter @tiltcheck/database run build
      pnpm --filter @tiltcheck/shared build
      pnpm --filter @tiltcheck/auth build
    - pnpm build
    - pnpm lint || echo "Lint failed but continuing"
    - pnpm test || echo "Tests failed but continuing"
    - mkdir -p coverage
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 1 week
