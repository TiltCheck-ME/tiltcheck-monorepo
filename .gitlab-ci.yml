image: node:20

stages:
  - build-test
  - auto-fix

variables:
  PNPM_HOME: ".pnpm-store"

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
    - node_modules

before_script:
  - corepack enable
  - corepack prepare pnpm@9.0.0 --activate
  - pnpm config set store-dir .pnpm-store
  - pnpm install --frozen-lockfile

build-test:
  stage: build-test
  script:
    - mkdir -p coverage
    - echo "Pipeline run at $(date)" > coverage/pipeline-info.txt
    # pnpm build runs scripts/ordered-build.sh which handles all dependencies correctly
    - pnpm build
    - pnpm lint
    - pnpm test
    - mkdir -p coverage
    - echo "Pipeline run at $(date)" > coverage/pipeline-info.txt
    - |
      if [ ! -f coverage/index.html ] && [ ! -f coverage/lcov.info ]; then
        echo "No coverage files found, creating placeholder" > coverage/no-coverage.txt
      fi
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 1 week

# Auto-fix pipeline issues in merge requests
auto-fix-pipeline-issues:
  stage: auto-fix
  image: node:20
  script:
    - |
      set -e

      echo "🔍 Scanning for pipeline issues..."

      # Check if this is a merge request
      if [ -z "$CI_MERGE_REQUEST_IID" ]; then
        echo "⏭️  Not a merge request, skipping auto-fix"
        exit 0
      fi

      # Install required tools
      apt-get update && apt-get install -y git curl jq

      # Run validation script
      node scripts/validate-and-fix-ci.cjs

      # Check if there are changes
      if git diff --quiet; then
        echo "✅ No issues found, pipeline is clean"
        exit 0
      fi

      # Configure git
      git config user.email "ci-validator@gitlab.com"
      git config user.name "CI/CD Validator Bot"

      # Create a branch for fixes
      FIX_BRANCH="ci-autofix/${CI_MERGE_REQUEST_IID}-${CI_PIPELINE_ID}"
      git checkout -b "$FIX_BRANCH"

      # Commit fixes
      git add .gitlab-ci.yml package.json apps/*/package.json modules/*/package.json packages/*/package.json 2>/dev/null || true
      git commit -m "fix(ci): auto-fix pipeline configuration issues

- Updated Node.js version for dependency compatibility
- Fixed version mismatches between CI image and dependencies
- Validated .gitlab-ci.yml syntax and configuration
" || echo "No changes to commit"

      # Push using token (prefer GITLAB_TOKEN, fallback to CI_JOB_TOKEN)
      if [ -n "$GITLAB_TOKEN" ]; then
        PUSH_TOKEN="$GITLAB_TOKEN"
      else
        PUSH_TOKEN="$CI_JOB_TOKEN"
      fi

      git push "https://oauth2:${PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:"$FIX_BRANCH" || true

      # Create MR via API if possible
      MR_TITLE="Auto-fix CI issues for MR !${CI_MERGE_REQUEST_IID}"
      MR_DESCRIPTION="Automated fixes for CI configuration issues detected in the MR pipeline."

      if [ -n "$GITLAB_TOKEN" ]; then
        API_TOKEN_HEADER="PRIVATE-TOKEN: ${GITLAB_TOKEN}"
      else
        API_TOKEN_HEADER="JOB-TOKEN: ${CI_JOB_TOKEN}"
      fi

      CREATE_MR_RESPONSE=$(curl -sS -X POST \
        -H "$API_TOKEN_HEADER" \
        --form "source_branch=${FIX_BRANCH}" \
        --form "target_branch=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}" \
        --form "title=${MR_TITLE}" \
        --form "description=${MR_DESCRIPTION}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests" || true)

      if echo "$CREATE_MR_RESPONSE" | jq -e '.web_url' >/dev/null 2>&1; then
        echo "✅ Created auto-fix MR: $(echo "$CREATE_MR_RESPONSE" | jq -r '.web_url')"
      else
        echo "⚠️  Could not create MR automatically. You can open one from branch: $FIX_BRANCH"
        echo "$CREATE_MR_RESPONSE" | jq -r '.message? // .error? // empty' || true
      fi
  only:
    - merge_requests
  allow_failure: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
