#!/usr/bin/env node

/**
 * Bundle discord-bot (and optionally dad-bot) into standalone .js files.
 *
 * All @tiltcheck/* workspace packages are inlined into the bundle.
 * External npm packages (discord.js, dotenv, etc.) are kept external
 * and must be installed on the target server via a minimal package.json.
 *
 * Usage:
 *   node scripts/bundle-bot.mjs                  # bundle discord-bot only
 *   node scripts/bundle-bot.mjs --all            # bundle both bots
 *   node scripts/bundle-bot.mjs --bot dad-bot    # bundle dad-bot only
 */

import { build } from 'esbuild';
import { mkdirSync, writeFileSync, readFileSync } from 'fs';
import path from 'path';

const ROOT = process.cwd();
const DIST = path.join(ROOT, 'dist-bundle');

// External packages that must NOT be bundled (native modules, WASM, large deps)
const EXTERNAL = [
  // Discord
  'discord.js',
  // Environment
  'dotenv',
  // Validation
  'zod',
  // Database
  '@supabase/supabase-js',
  // Logging
  'pino',
  'pino-pretty',
  // AI / LLM
  '@ai-sdk/openai',
  'ai',
  // Solana / Crypto
  '@solana/pay',
  '@solana/spl-token',
  '@solana/web3.js',
  // Ethereum
  'ethers',
  // Math
  'bignumber.js',
  // Utilities
  'uuid',
];

// Parse CLI args
const args = process.argv.slice(2);
const bundleAll = args.includes('--all');
const botArg = args.find((_, i, a) => a[i - 1] === '--bot');

const bots = [];
if (bundleAll) {
  bots.push(
    { name: 'discord-bot', entry: 'apps/discord-bot/src/index.ts' },
    { name: 'dad-bot', entry: 'apps/dad-bot/src/index.ts' },
  );
} else if (botArg) {
  bots.push({ name: botArg, entry: `apps/${botArg}/src/index.ts` });
} else {
  bots.push({ name: 'discord-bot', entry: 'apps/discord-bot/src/index.ts' });
}

mkdirSync(DIST, { recursive: true });

for (const bot of bots) {
  console.log(`\nBundling ${bot.name}...`);
  const outfile = path.join(DIST, `${bot.name}.bundle.mjs`);

  await build({
    entryPoints: [path.join(ROOT, bot.entry)],
    bundle: true,
    outfile,
    platform: 'node',
    target: 'node20',
    format: 'esm',
    external: EXTERNAL,
    sourcemap: true,
    minify: false, // keep readable for debugging on VPS
    // Force ESM resolution so workspace packages resolve via "import" condition
    conditions: ['import', 'module', 'node'],
    mainFields: ['module', 'main'],
    // Resolve .ts source files directly
    resolveExtensions: ['.ts', '.js', '.mjs', '.json'],
    banner: {
      js: [
        '// TiltCheck bundled bot - generated by scripts/bundle-bot.mjs',
        '// Run with: node ' + `${bot.name}.bundle.mjs`,
        '',
      ].join('\n'),
    },
    logLevel: 'info',
  });

  console.log(`  -> ${outfile}`);
}

// Generate a minimal package.json for the deploy target
const deployPkg = {
  name: 'tiltcheck-deploy',
  version: '1.0.0',
  private: true,
  type: 'module',
  scripts: {
    'start:discord-bot': 'node discord-bot.bundle.mjs',
    'start:dad-bot': 'node dad-bot.bundle.mjs',
  },
  dependencies: {},
};

// Collect versions from the lockfile-resolved packages
const discordBotPkg = JSON.parse(
  readFileSync(path.join(ROOT, 'apps/discord-bot/package.json'), 'utf8')
);
const dadBotPkg = JSON.parse(
  readFileSync(path.join(ROOT, 'apps/dad-bot/package.json'), 'utf8')
);

// Merge all external deps with their versions
const allDeps = { ...discordBotPkg.dependencies, ...dadBotPkg.dependencies };
for (const pkg of EXTERNAL) {
  if (allDeps[pkg]) {
    deployPkg.dependencies[pkg] = allDeps[pkg];
  }
}

// Some deps come from workspace sub-packages, not the bot directly.
// Add them with reasonable versions if missing.
const fallbackVersions = {
  'zod': '^4.1.0',
  '@supabase/supabase-js': '^2.47.0',
  'pino': '^10.3.0',
  'pino-pretty': '^10.3.0',
  '@ai-sdk/openai': '^2.0.0',
  'ai': '^5.0.0',
  '@solana/pay': '^0.2.6',
  '@solana/spl-token': '^0.4.9',
  '@solana/web3.js': '^1.95.0',
  'ethers': '^6.13.0',
  'bignumber.js': '^9.3.0',
  'uuid': '^13.0.0',
};

for (const pkg of EXTERNAL) {
  if (!deployPkg.dependencies[pkg]) {
    deployPkg.dependencies[pkg] = fallbackVersions[pkg] || '*';
  }
}

const pkgPath = path.join(DIST, 'package.json');
writeFileSync(pkgPath, JSON.stringify(deployPkg, null, 2) + '\n');
console.log(`\nGenerated ${pkgPath}`);

// Generate a PM2 ecosystem file for the deploy target
const ecosystem = `// PM2 config for TiltCheck bundled bots
// Usage: pm2 start ecosystem.config.cjs
module.exports = {
  apps: [
    {
      name: 'discord-bot',
      script: './discord-bot.bundle.mjs',
      env: {
        NODE_ENV: 'production',
      },
      max_memory_restart: '200M',
    },
    {
      name: 'dad-bot',
      script: './dad-bot.bundle.mjs',
      env: {
        NODE_ENV: 'production',
      },
      max_memory_restart: '150M',
    },
  ],
};
`;

const ecoPath = path.join(DIST, 'ecosystem.config.cjs');
writeFileSync(ecoPath, ecosystem);
console.log(`Generated ${ecoPath}`);

// Generate a .env.example
const envExample = `# TiltCheck Discord Bot - Production Environment
# Copy this to .env and fill in your values

# Discord Bot (required)
DISCORD_TOKEN=
DISCORD_CLIENT_ID=
DISCORD_GUILD_ID=

# DA&D Bot (if running dad-bot)
DAD_DISCORD_TOKEN=
DAD_DISCORD_CLIENT_ID=
DAD_DISCORD_GUILD_ID=

# Supabase (optional - falls back to in-memory)
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Solana (for tip/airdrop commands)
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com

# API endpoint (for tilt events and mod reports)
BACKEND_URL=https://api.tiltcheck.me

# Dashboard URL (for user-facing links in embeds)
DASHBOARD_URL=https://tiltcheck.app/dashboard

# Bot settings
NODE_ENV=production
SUSLINK_AUTO_SCAN=true
TRUST_THRESHOLD=60
`;

const envPath = path.join(DIST, '.env.example');
writeFileSync(envPath, envExample);
console.log(`Generated ${envPath}`);

console.log(`
========================================
  Bundle complete!

  Deploy steps:
  1. Copy the dist-bundle/ folder to your server
  2. cd dist-bundle && npm install
  3. Copy .env.example to .env and fill in values
  4. pm2 start ecosystem.config.cjs
========================================
`);
