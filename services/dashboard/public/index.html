<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TiltCheck Trust Dashboard</title>
<style>
 body { font-family: system-ui, sans-serif; margin: 1rem; background:#111; color:#eee; }
 h1 { margin-top:0; }
 section { margin-bottom:1.5rem; }
 table { border-collapse: collapse; width:100%; margin-top:0.5rem; }
 th, td { padding:4px 6px; border:1px solid #333; font-size:12px; }
 .neg { color:#ff5f5f; }
 .pos { color:#5fff9d; }
 .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:11px; }
 .sev1 { background:#1f3b1f; }
 .sev2 { background:#3b3b1f; }
 .sev3 { background:#3b2a1f; }
 .sev4 { background:#3b1f1f; }
 .sev5 { background:#611f1f; }
 #alerts .alert { background:#2a162a; padding:6px 8px; margin:4px 0; border-left:4px solid #d34; font-size:12px; }
 #ticker { max-height:220px; overflow:auto; font-size:12px; background:#181818; padding:6px; }
 #ticker .event { white-space:nowrap; }
 button { background:#222; color:#eee; border:1px solid #444; padding:6px 10px; cursor:pointer; }
 button:disabled { opacity:0.4; cursor:not-allowed; }
</style>
</head>
<body>
<h1>TiltCheck Trust Dashboard</h1>
<button id="snapshotBtn">Request Snapshot</button>
<span id="snapshotInfo"></span>
<div id="configInfo" style="margin-top:8px; font-size:0.85em; color:#888;"></div>
<section id="domainMovers"><h2>Domain Movers</h2><table><thead><tr><th>Domain</th><th>Î”</th><th>Events</th><th>Last Sev</th><th>Score</th></tr></thead><tbody></tbody></table></section>
<section id="casinoMovers"><h2>Casino Movers</h2><table><thead><tr><th>Casino</th><th>Î”</th><th>Events</th><th>Last Sev</th><th>Score</th></tr></thead><tbody></tbody></table></section>
<section id="severity"><h2>Severity Distribution</h2><canvas id="severityChart" height="120"></canvas><div id="severityBars" style="display:none"></div></section>
<section id="sparklines"><h2>Sparklines</h2><div id="sparkDomains"></div><div id="sparkCasinos"></div></section>
<section id="alerts"><h2>Risk Alerts</h2></section>
<section id="ticker"><h2>Live Events</h2><div id="events"></div></section>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const sevEmoji = s => s>=5?'ðŸ”´':s===4?'ðŸŸ ':s===3?'ðŸŸ¡':'ðŸŸ¢';
const snapshotBtn = document.getElementById('snapshotBtn');
let lastSnapshotTs = 0;
const throttleWindow = 5000;
async function refreshRollups(){
  const r = await fetch('/api/rollups/latest').then(r=>r.json());
  const domainMap = r?.domain?.domains || {}; const casinoMap = r?.casino?.casinos || {};
  renderMovers(domainMap, document.querySelector('#domainMovers tbody'));
  renderMovers(casinoMap, document.querySelector('#casinoMovers tbody'));
}
function renderMovers(map, tbody){
  tbody.innerHTML='';
  const entries = Object.entries(map).sort((a,b)=>a[1].totalDelta-b[1].totalDelta);
  entries.slice(0,20).forEach(([k,v])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${k}</td><td class="${v.totalDelta<0?'neg':'pos'}">${v.totalDelta}</td><td>${v.events}</td><td>${v.lastSeverity||''}</td><td>${v.lastScore||''}</td>`;
    tbody.appendChild(tr);
  });
}
async function refreshSeverity(){
  const s = await fetch('/api/severity').then(r=>r.json());
  const data = Object.entries(s.buckets).map(([sev,count])=>({ sev: parseInt(sev), count }));
  updateSeverityChart(data);
}
async function refreshAlerts(){
  const a = await fetch('/api/alerts').then(r=>r.json());
  const box = document.getElementById('alerts');
  box.querySelectorAll('.alert').forEach(n=>n.remove());
  a.alerts.forEach(al=>{
    const div=document.createElement('div');
    div.className='alert';
    div.textContent=`${al.kind} :: ${al.entity} ${al.totalDelta??''} ${al.severity?('sev '+al.severity):''}`;
    box.appendChild(div);
  });
}
function updateSnapshotInfo(){
  const el=document.getElementById('snapshotInfo');
  if(!lastSnapshotTs){ el.textContent='No snapshot yet'; return; }
  const age = Date.now()-lastSnapshotTs; el.textContent=`Snapshot age: ${(age/1000).toFixed(1)}s`;
  const remaining = throttleWindow - age;
  snapshotBtn.disabled = remaining>0; if(remaining>0){ snapshotBtn.textContent=`Wait ${(remaining/1000).toFixed(1)}s`; } else snapshotBtn.textContent='Request Snapshot';
}
snapshotBtn.onclick=()=>{ fetch('/api/request-snapshot',{method:'POST'}); };
setInterval(()=>{updateSnapshotInfo();},500);
async function refreshHealth(){
  const h = await fetch('/api/health').then(r=>r.json());
  if(h.lastSnapshotTs) lastSnapshotTs = h.lastSnapshotTs;
}
async function refreshConfig(){
  const c = await fetch('/api/config').then(r=>r.json());
  const parts = [`Retention: ${c.retentionDays}d`, `Poll: ${Math.round(c.pollIntervalMs/1000)}s`];
  document.getElementById('configInfo').textContent = parts.join(' â€¢ ');
}
function initSSE(){
  const es = new EventSource('/events');
  es.addEventListener('init', ev=>{ /* ignore initial for now */ });
  es.addEventListener('trust', ev=>{
    const data=JSON.parse(ev.data);
    const wrap=document.getElementById('events');
    const div=document.createElement('div');
    div.className='event';
    div.textContent=`${new Date(data.ts).toLocaleTimeString()} ${sevEmoji(data.severity||1)} ${data.type} ${data.entity} ${data.delta||''}`;
    wrap.prepend(div);
    while(wrap.children.length>200) wrap.removeChild(wrap.lastChild);
  });
}
function loop(){ refreshRollups(); refreshSeverity(); refreshAlerts(); refreshHealth(); refreshConfig(); }
setInterval(loop, 10000);
loop(); initSSE();

// Severity Chart (Chart.js)
let severityChart;
function updateSeverityChart(data){
  const ctx = document.getElementById('severityChart');
  if(!severityChart){
    severityChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: data.map(d=>d.sev), datasets: [{ label:'Severity Events', data: data.map(d=>d.count), backgroundColor: data.map(d=> d.sev>=5?'#ff3d3d':d.sev===4?'#ff7d3d':d.sev===3?'#ffc53d':d.sev===2?'#d2ff3d':'#3dff7d') }] },
      options: { scales: { y: { beginAtZero:true } }, plugins:{ legend:{ display:false } } }
    });
  } else {
    severityChart.data.datasets[0].data = data.map(d=>d.count);
    severityChart.update();
  }
}

// Sparklines
async function refreshSparklines(){
  const d = await fetch('/api/sparklines').then(r=>r.json());
  renderSparklineGroup(d.domains, document.getElementById('sparkDomains'), 'domain');
  renderSparklineGroup(d.casinos, document.getElementById('sparkCasinos'), 'casino');
}
function renderSparklineGroup(items, container, label){
  container.innerHTML='';
  items.forEach(item => {
    const wrap=document.createElement('div'); wrap.style.margin='4px 0';
    const title=document.createElement('div'); title.textContent=`${label}: ${item.entity}`; title.style.fontSize='11px';
    const canvas=document.createElement('canvas'); canvas.width=150; canvas.height=40;
    wrap.appendChild(title); wrap.appendChild(canvas); container.appendChild(wrap);
    drawSparkline(canvas, item.deltas);
  });
}
function drawSparkline(canvas, deltas){
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!deltas.length) return;
  const pad=4; const w=canvas.width - pad*2; const h=canvas.height - pad*2;
  const max=Math.max(...deltas); const min=Math.min(...deltas); const span=max-min || 1;
  ctx.strokeStyle='#4ec9f0'; ctx.lineWidth=1; ctx.beginPath();
  deltas.forEach((v,i)=>{
    const x = pad + (i/(deltas.length-1))*w;
    const y = pad + (1 - (v-min)/span)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  // zero line
  if(min<0 && max>0){
    const zeroY = pad + (1 - (0-min)/span)*h;
    ctx.strokeStyle='#555'; ctx.beginPath(); ctx.moveTo(pad, zeroY); ctx.lineTo(pad+w, zeroY); ctx.stroke();
  }
}
setInterval(refreshSparklines, 15000); refreshSparklines();
</script>
</body>
</html>