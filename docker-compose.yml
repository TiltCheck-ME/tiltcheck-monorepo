# TiltCheck Docker Compose
# Deploy core services with: docker-compose up -d
# For bots only: docker-compose up -d discord-bot dad-bot

services:
  # ===========================================
  # DISCORD BOTS
  # ===========================================

  discord-bot:
    build:
      context: .
      dockerfile: apps/discord-bot/Dockerfile
    container_name: tiltcheck-bot
    environment:
      - NODE_ENV=production
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_GUILD_ID=${DISCORD_GUILD_ID}
      - DASHBOARD_URL=${DASHBOARD_URL:-https://tiltcheck.app/dashboard}
      - BACKEND_URL=${BACKEND_URL:-http://api:3001}
      - SUSLINK_AUTO_SCAN=${SUSLINK_AUTO_SCAN:-true}
      - TRUST_THRESHOLD=${TRUST_THRESHOLD:-60}
      - DISCORD_BOT_HEALTH_PORT=8081
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - tiltcheck
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/bot-ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  dad-bot:
    build:
      context: .
      dockerfile: apps/discord-bot/Dockerfile
    container_name: tiltcheck-dad-bot
    entrypoint: ["node", "apps/dad-bot/dist/index.js"]
    environment:
      - NODE_ENV=production
      - DISCORD_TOKEN=${DAD_DISCORD_TOKEN}
      - DISCORD_CLIENT_ID=${DAD_DISCORD_CLIENT_ID}
      - DISCORD_GUILD_ID=${DAD_DISCORD_GUILD_ID}
      - DAD_BOT_HEALTH_PORT=8082
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - tiltcheck

  # ===========================================
  # API & SERVICES
  # ===========================================

  api:
    build:
      context: .
      dockerfile: apps/discord-bot/Dockerfile
    container_name: tiltcheck-api
    entrypoint: ["node", "apps/api/dist/index.js"]
    expose:
      - "3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - tiltcheck

  trust-rollup:
    build:
      context: .
      dockerfile: apps/discord-bot/Dockerfile
    container_name: tiltcheck-rollup
    entrypoint: ["node", "apps/trust-rollup/dist/index.js"]
    environment:
      - NODE_ENV=production
      - TRUST_ROLLUP_HEALTH_PORT=8083
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - tiltcheck
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/rollup-ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

networks:
  tiltcheck:
    driver: bridge
